name: Auto-generate sitemap & robots.txt

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository with credentials
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      # 2️⃣ Generate sitemap.xml
      - name: Generate sitemap.xml
        run: |
          echo '<?xml version="1.0" encoding="UTF-8"?>' > sitemap.xml
          echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> sitemap.xml

          # Loop through all HTML files, including subfolders
          find . -type f -name "*.html" | while read f; do
            # Remove leading ./ for URL
            url_path=$(echo "$f" | sed 's|^\./||')

            # Skip 404.html
            if [[ "$url_path" == "404.html" ]]; then
              continue
            fi

            # Determine priority
            if [[ "$url_path" == "index.html" ]]; then
              priority="1.0"
              changefreq="weekly"
            elif [[ "$url_path" == *.html && ! "$url_path" == */* ]]; then
              priority="0.8"
              changefreq="monthly"
            else
              priority="0.6"
              changefreq="monthly"
            fi

            # Get file last modified date in ISO 8601 format
            lastmod=$(date -u -r "$f" +"%Y-%m-%dT%H:%M:%S+00:00")

            # Add URL entry
            echo "  <url><loc>https://signalsync.tv/${url_path}</loc><lastmod>${lastmod}</lastmod><changefreq>${changefreq}</changefreq><priority>${priority}</priority></url>" >> sitemap.xml
          done

          echo '</urlset>' >> sitemap.xml

      # 3️⃣ Ensure robots.txt exists
      - name: Ensure robots.txt exists
        run: |
          if [ ! -f robots.txt ]; then
            echo "User-agent: *" > robots.txt
            echo "Allow: /" >> robots.txt
            echo "Sitemap: https://signalsync.tv/sitemap.xml" >> robots.txt
          fi

      # 4️⃣ Commit and push changes
      - name: Commit and push updates
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add sitemap.xml robots.txt
          git commit -m "Auto-update sitemap and robots.txt [skip ci]" || echo "No changes to commit"
          git push origin main
