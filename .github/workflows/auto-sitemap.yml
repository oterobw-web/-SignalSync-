name: Auto-generate sitemap & robots.txt (HTML + Images)

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false  # GH_PAT will handle push

      # 2️⃣ Generate sitemap.xml with images
      - name: Generate sitemap.xml
        run: |
          sitemap_file="sitemap.xml"
          echo '<?xml version="1.0" encoding="UTF-8"?>' > $sitemap_file
          echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:image="http://www.google.com/schemas/sitemap-image/1.1">' >> $sitemap_file

          # Loop through HTML files
          find . -type f -name "*.html" | while read f; do
            url_path=$(echo "$f" | sed 's|^\./||')
            [[ "$url_path" == "404.html" ]] && continue

            if [[ "$url_path" == "index.html" ]]; then
              priority="1.0"
              changefreq="weekly"
            elif [[ "$url_path" == *.html && ! "$url_path" == */* ]]; then
              priority="0.8"
              changefreq="monthly"
            else
              priority="0.6"
              changefreq="monthly"
            fi

            lastmod=$(date -u -r "$f" +"%Y-%m-%dT%H:%M:%S+00:00")

            echo "  <url><loc>https://signalsync.tv/${url_path}</loc><lastmod>${lastmod}</lastmod><changefreq>${changefreq}</changefreq><priority>${priority}</priority>" >> $sitemap_file

            # Include all images in images/ folder globally
            find images/ -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" -o -iname "*.gif" \) | while read img; do
              img_url=$(echo "$img" | sed 's|^\./|https://signalsync.tv/|')
              echo "    <image:image><image:loc>${img_url}</image:loc></image:image>" >> $sitemap_file
            done

            echo "  </url>" >> $sitemap_file
          done

          echo '</urlset>' >> $sitemap_file

      # 3️⃣ Ensure robots.txt exists and points to sitemap
      - name: Update robots.txt
        run: |
          if [ ! -f robots.txt ]; then
            echo "User-agent: *" > robots.txt
            echo "Allow: /" >> robots.txt
          fi

          # Ensure sitemap line is correct
          grep -q "Sitemap:" robots.txt && sed -i 's|Sitemap:.*|Sitemap: https://signalsync.tv/sitemap.xml|' robots.txt || echo "Sitemap: https://signalsync.tv/sitemap.xml" >> robots.txt

      # 4️⃣ Commit and push updates using GH_PAT
      - name: Commit and push updates
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add sitemap.xml robots.txt
          git diff --quiet || git commit -m "Auto-update sitemap + images + robots.txt [skip ci]"
          git push https://$GH_PAT@github.com/oterobw-web/-SignalSync-.git HEAD:main
